import{_binderNode as T,_ItemModel as f,_key as s,_parent as u,_validators as n,AbstractModel as p,ArrayModel as V,getBinderNode as h,ObjectModel as c}from"./Models.js";import{ValidityStateValidator as I}from"./Validators.js";import{_validity as m}from"./Validity.js";const o=Symbol("ownErrorsSymbol"),d=Symbol("visited");function v(i){return typeof i.property=="string"?i.property:h(i.property).name}const A=new WeakMap,E=i=>{const e=A;if(e.has(i))return A.get(i);const t=i.model[f].createEmptyValue();return e.set(i,t),t},l=new Event("binder-node-changed");class g extends EventTarget{model;[m];[d]=!1;[n];[o];validityStateValidator;constructor(e){super(),this.model=e,e[T]=this,this.validityStateValidator=new I,this.initializeValue(),this[n]=e[n]}get parent(){const e=this.model[u];return e instanceof p?h(e):void 0}get binder(){return this.parent?this.parent.binder:this}get name(){let e=this.model;const t=[];for(;e[u]instanceof p;)t.unshift(String(e[s])),e=e[u];return t.join(".")}get value(){this.parent.value===void 0&&this.parent.initializeValue(!0);const e=this.model[s];return this.parent.value[e]}set value(e){this.setValueState(e)}get defaultValue(){if(this.isArrayItem()){const t=this.parent.asArray();return E(t)}const e=this.model[s];return this.parent.defaultValue[e]}get dirty(){return this.value!==this.defaultValue}get validators(){return this[n]}set validators(e){this[n]=e,this.dispatchEvent(l)}get visited(){return this[d]}set visited(e){this[d]!==e&&(this[d]=e,this.updateValidation().catch(()=>{}),this.dispatchEvent(l))}get errors(){return[...this.getChildBinderNodes()].reduce((t,r)=>[...t,...r.errors],[]).concat(this.ownErrors)}get ownErrors(){return this[o]?this[o]:[]}get invalid(){return this.errors.length>0}get required(){return this[n].some(e=>e.impliesRequired)}for(e){const t=h(e);if(t.binder!==this.binder)throw new Error("Unknown binder");return t}async validate(){const e=(await Promise.all([...this.requestValidationOfDescendants(),...this.requestValidationWithAncestors()])).flat();return this.setErrorsWithDescendants(e.length?e:void 0),this.update(),e}addValidator(e){this.validators=[...this[n],e],this.dispatchEvent(l)}appendItem(e){const t=this.asArray(),r=e??t.model[f].createEmptyValue();t.value=[...t.value??[],r]}prependItem(e){const t=this.asArray(),r=e??t.model[f].createEmptyValue();t.value=[r,...t.value??[]]}removeSelf(){const e=this.asArrayItem(),t=this.model[s],r=e.parent;r.value=(r.value??[]).filter((y,a)=>a!==t)}clearValidation(){this[d]&&(this[d]=!1,this.dispatchEvent(l));let e=!1;return this[o]&&(this[o]=void 0,e=!0,this.dispatchEvent(l)),[...this.getChildBinderNodes()].filter(t=>t.clearValidation()).length>0&&(e=!0),e}async updateValidation(){this[d]?await this.validate():(this.dirty||this.invalid)&&await Promise.all([...this.getChildBinderNodes()].map(async e=>e.updateValidation()))}update(e){this.parent&&this.parent.update()}setErrorsWithDescendants(e){const{name:t}=this,r=e?e.filter(a=>v(a)===t):void 0,y=e?e.filter(a=>v(a).startsWith(t)):void 0;this[o]=r;for(const a of this.getChildBinderNodes())a.setErrorsWithDescendants(y);this.dispatchEvent(l)}*getChildBinderNodes(){if(this.value!==void 0){if(this.model instanceof c){if(this.defaultValue)for(const[,e]of c.getOwnAndParentGetters(this.model)){const t=e.call(this.model);t instanceof p&&(yield h(t))}}else if(this.model instanceof V)for(const e of this.model)yield e}}runOwnValidators(){return this[m]&&!this[m].valid?this[m].badInput?[this.binder.requestValidation(this.model,this.validityStateValidator)]:[...this[n],this.validityStateValidator].map(async e=>this.binder.requestValidation(this.model,e)):this[n].map(async e=>this.binder.requestValidation(this.model,e))}requestValidationOfDescendants(){return[...this.getChildBinderNodes()].reduce((e,t)=>[...e,...t.runOwnValidators(),...t.requestValidationOfDescendants()],[])}requestValidationWithAncestors(){return[...this.runOwnValidators(),...this.parent?this.parent.requestValidationWithAncestors():[]]}initializeValue(e=!1){this.parent&&(this.parent.value===void 0||this.parent.defaultValue===void 0)&&this.parent.initializeValue(!0);const t=this.model[s];let r=this.parent?this.parent.value[this.model[s]]:void 0;r===void 0&&(e||!this.parent?(r=this.model.constructor.createEmptyValue(),this.setValueState(r,this.defaultValue===void 0)):this.parent.model instanceof c&&!(t in(this.parent.value||{}))&&this.setValueState(void 0,this.defaultValue===void 0))}setValueState(e,t=!1){const r=this.model[u],y=this.model[s];if(r instanceof c){const a={...this.parent.value,[y]:e};this.parent.setValueState(a,t);return}if(e===void 0)throw new TypeError("Unexpected undefined value");if(this.isArrayItem()){const a=(this.parent.value??[]).slice();a[y]=e,this.parent.setValueState(a,t)}else{const a=r;t&&!a.dirty&&(a.defaultValue=e),a.value=e}}isArray(){return this.model instanceof V}asArray(){if(!this.isArray())throw new TypeError("Model is not array");return this}isArrayItem(){return this.parent?.model instanceof V}asArrayItem(){if(!this.isArrayItem())throw new TypeError("Model is not an array item");return this}}export{g as BinderNode,l as CHANGED};
//# sourceMappingURL=BinderNode.js.map
